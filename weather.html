<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Weather AI Assistant - JOMPO FarmLink</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="style.css" />
</head>

<body class="bg-green-50">
  <nav class="bg-green-800 text-white p-4 flex justify-between items-center sticky top-0 z-50">
  <a href="dashboard.html" class="text-xl font-bold">ðŸŒ¿ JOMPO FarmLink</a>
  <div class="space-x-4">
    <a href="dashboard.html" class="hover:text-green-200">Dashboard</a>
    <a href="market.html" class="hover:text-green-200">Market</a>
    <a href="ai.html" class="hover:text-green-200">AI Assistant</a>
    <a href="weather.html" class="hover:text-green-200">Weather</a>
    <a href="index.html" class="bg-red-600 px-3 py-1 rounded hover:bg-red-700">Logout</a>
  </div>
</nav>

  <!-- Navigation -->
  <nav class="bg-green-800 text-white p-4 flex justify-between items-center">
    <a href="dashboard.html" class="text-2xl font-bold">JOMPO FarmLink</a>
    <div>
      <a href="index.html" class="hover:underline">Home</a>
    </div>
  </nav>

  <!-- Weather Section -->
  <section class="p-6 max-w-3xl mx-auto">
    <h2 class="text-3xl font-bold text-green-800 mb-6">Weather AI Assistant</h2>
    <p class="text-gray-700 mb-4">
      Get real-time weather forecasts, AI farming insights, and recommendations based on your area.
    </p>

    <!-- Input -->
    <div class="flex space-x-2">
      <input
        id="locationInput"
        type="text"
        class="w-full p-3 border rounded focus:ring-2 focus:ring-green-700"
        placeholder="Enter your location e.g. Kisumu, Kenya"
      />
      <button
        id="getWeather"
        class="bg-green-700 text-white px-5 py-2 rounded hover:bg-green-800"
      >
        Get Weather
      </button>
    </div>

    <!-- Weather Display -->
    <div id="weatherData" class="mt-6 bg-white shadow p-4 rounded hidden">
      <h3 class="font-bold text-green-700 mb-2">Weather Update:</h3>
      <p id="weatherText" class="text-gray-800 whitespace-pre-line"></p>
    </div>

    <!-- AI Weather Insights -->
    <div id="aiInsights" class="mt-6 bg-white shadow p-4 rounded hidden">
      <h3 class="font-bold text-green-700 mb-2">AI Agricultural Advice:</h3>
      <p id="aiAdvice" class="text-gray-800 whitespace-pre-line"></p>
    </div>
  </section>

  <script>
    const weatherKey = "https://api.open-meteo.com/v1/forecast";

    document.getElementById("getWeather").addEventListener("click", async () => {
      const location = document.getElementById("locationInput").value.trim();
      if (!location) return alert("Please enter a location");

      document.getElementById("weatherData").classList.remove("hidden");
      document.getElementById("weatherText").textContent = "Fetching weather data...";

      try {
        // Get coordinates from Open Meteo Geocoding API
        const geoRes = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${location}`);
        const geoData = await geoRes.json();
        if (!geoData.results || geoData.results.length === 0)
          return alert("Location not found. Try another name.");

        const { latitude, longitude, name, country } = geoData.results[0];

        // Fetch weather data
        const weatherRes = await fetch(
          `${weatherKey}?latitude=${latitude}&longitude=${longitude}&current_weather=true`
        );
        const weatherData = await weatherRes.json();

        const temp = weatherData.current_weather.temperature;
        const wind = weatherData.current_weather.windspeed;
        const weatherInfo = `Location: ${name}, ${country}\nTemperature: ${temp}Â°C\nWind Speed: ${wind} km/h`;

        document.getElementById("weatherText").textContent = weatherInfo;

        // Show AI recommendation
        document.getElementById("aiInsights").classList.remove("hidden");
        document.getElementById("aiAdvice").textContent = "Generating AI farming insights...";

        const aiRes = await fetch("https://us-central1-jompo-farmlink-web.cloudfunctions.net/askAI", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            query: `Based on ${temp}Â°C and ${wind} km/h wind in ${name}, Kenya, what should farmers do today?`,
          }),
        });
        const aiData = await aiRes.json();
        document.getElementById("aiAdvice").textContent =
          aiData.reply || "AI could not generate a response.";
      } catch (error) {
        document.getElementById("weatherText").textContent = "Error fetching weather data.";
        console.error(error);
      }
    });
  </script>
  <!-- ðŸŒ¿ JOMPO Floating Chatbot -->
<div id="chatbot"></div>
<script src="chatbot.js"></script>

</body>
</html>
