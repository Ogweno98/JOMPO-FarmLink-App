// =======================
// Firebase Config
// =======================
const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_PROJECT.appspot.com",
  messagingSenderId: "YOUR_SENDER_ID",
  appId: "YOUR_APP_ID"
};

if (!firebase.apps.length) {
  firebase.initializeApp(firebaseConfig);
}

const auth = firebase.auth();
const db = firebase.firestore();

// =======================
// Navbar Auth Links
// =======================
auth.onAuthStateChanged(user => {
  const authLinks = document.getElementById("authLinks");
  if (!authLinks) return;

  if (user) {
    authLinks.innerHTML = `
      <span class="mr-4">Hi, ${user.email}</span>
      <button id="logoutBtn" class="bg-red-500 hover:bg-red-600 px-4 py-2 rounded">
        Logout
      </button>
    `;
    document.getElementById("logoutBtn").addEventListener("click", () => {
      auth.signOut();
    });
  } else {
    authLinks.innerHTML = `
      <a href="login.html" class="mr-4">Login</a>
      <a href="register.html" class="bg-green-500 hover:bg-green-600 px-4 py-2 rounded">Register</a>
    `;
  }
});

// =======================
// Marketplace Logic
// =======================
async function loadMarketplace() {
  const marketplaceContainer = document.getElementById("marketplaceContainer");
  const noResults = document.getElementById("noResults");
  const categorySelect = document.getElementById("filterCategory");

  if (!marketplaceContainer) return; // not on marketplace page

  try {
    const snapshot = await db.collection("listings").get();
    let listings = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

    // Populate category filter (unique values)
    if (categorySelect) {
      const categories = [...new Set(listings.map(item => item.category).filter(Boolean))];
      categories.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat;
        option.textContent = cat;
        categorySelect.appendChild(option);
      });
    }

    // Render listings
    function renderListings(filtered = listings) {
      marketplaceContainer.innerHTML = "";

      if (!filtered.length) {
        noResults.classList.remove("hidden");
        return;
      } else {
        noResults.classList.add("hidden");
      }

      filtered.forEach(item => {
        const card = document.createElement("div");
        card.className = "bg-white shadow-md rounded-lg p-4";

        card.innerHTML = `
          <h3 class="text-xl font-bold text-green-700">${item.name || "Unnamed Item"}</h3>
          <p class="text-gray-700">Category: ${item.category || "N/A"}</p>
          <p class="text-gray-700">Location: ${item.location || "Unknown"}</p>
          <p class="text-gray-900 font-semibold mt-2">Price: KES ${item.price || "0"}</p>
        `;

        marketplaceContainer.appendChild(card);
      });
    }

    renderListings();

    // Filters
    const searchInput = document.getElementById("searchInput");
    const filterLocation = document.getElementById("filterLocation");

    function applyFilters() {
      let filtered = listings;

      const searchValue = searchInput?.value.toLowerCase() || "";
      const locationValue = filterLocation?.value.toLowerCase() || "";
      const categoryValue = categorySelect?.value || "";

      filtered = filtered.filter(item =>
        (item.name || "").toLowerCase().includes(searchValue) &&
        (item.location || "").toLowerCase().includes(locationValue) &&
        (categoryValue ? item.category === categoryValue : true)
      );

      renderListings(filtered);
    }

    searchInput?.addEventListener("input", applyFilters);
    filterLocation?.addEventListener("input", applyFilters);
    categorySelect?.addEventListener("change", applyFilters);

  } catch (error) {
    console.error("Error loading marketplace:", error);
  }
}

document.addEventListener("DOMContentLoaded", loadMarketplace);


