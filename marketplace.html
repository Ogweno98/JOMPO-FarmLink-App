<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marketplace - JOMPO FarmLink</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-green-50 font-sans">
  <!-- Navbar -->
  <nav class="bg-green-800 text-white p-4 flex justify-between items-center">
    <a href="index.html" class="text-2xl font-bold">JOMPO FarmLink</a>
    <div id="authLinks"></div>
  </nav>

  <!-- Marketplace Section -->
  <section class="py-10 px-6 md:px-20">
    <h2 class="text-3xl font-bold text-green-800 mb-6">Marketplace</h2>

    <!-- Search and Filters -->
    <div class="mb-6 flex flex-col md:flex-row gap-4">
      <input type="text" id="searchInput" placeholder="Search by name or keyword..."
        class="px-4 py-2 border rounded w-full md:w-1/3 focus:outline-none focus:ring-2 focus:ring-green-600">

      <input type="text" id="filterLocation" placeholder="Filter by location"
        class="px-4 py-2 border rounded w-full md:w-1/3 focus:outline-none focus:ring-2 focus:ring-green-600">

      <select id="filterCategory"
        class="px-4 py-2 border rounded w-full md:w-1/3 focus:outline-none focus:ring-2 focus:ring-green-600">
        <option value="">All Categories</option>
      </select>
    </div>

    <div id="noResults" class="hidden text-red-600 font-semibold mb-6">
      No items found. Try adjusting your filters.
    </div>

    <div id="marketplaceContainer" class="grid md:grid-cols-3 gap-6"></div>
  </section>

  <!-- Footer -->
  <footer class="bg-green-800 text-white text-center py-4 mt-10">
    <p>&copy; 2025 JOMPO Digital Solutions. All rights reserved.</p>
  </footer>

  <!-- App Scripts -->
  <script src="app.js"></script>
  <div id="chatbot"></div>
  <script src="chatbot.js"></script>
  <script src="navbar.js"></script>

  <!-- Marketplace Logic -->
  <script>
    const db = firebase.firestore();
    const marketplaceContainer = document.getElementById('marketplaceContainer');
    const filterCategory = document.getElementById('filterCategory');
    const searchInput = document.getElementById('searchInput');
    const filterLocation = document.getElementById('filterLocation');
    const noResults = document.getElementById('noResults');

    // Default categories
    const defaultCategories = ["Cereals", "Vegetables", "Fruits", "Livestock", "Poultry", "Fish", "Seeds", "Fertilizers", "Machinery", "Agrochemicals"];

    // Load categories dynamically into dropdown
    function loadCategories() {
      filterCategory.innerHTML = `<option value="">All Categories</option>`;
      defaultCategories.forEach(cat => {
        const option = document.createElement("option");
        option.value = cat.toLowerCase();
        option.textContent = cat;
        filterCategory.appendChild(option);
      });
    }

    // Fetch & Display Marketplace Items
    async function loadMarketplace(category = "", search = "", location = "") {
      marketplaceContainer.innerHTML = "";
      let query = db.collection("marketplace").orderBy("timestamp", "desc");

      const snapshot = await query.get();
      let found = false;

      snapshot.forEach(doc => {
        const data = doc.data();
        const name = (data.name || "").toLowerCase();
        const cat = (data.category || "").toLowerCase();
        const loc = (data.location || "").toLowerCase();

        const match =
          (!category || cat.includes(category)) &&
          (!search || name.includes(search) || cat.includes(search)) &&
          (!location || loc.includes(location));

        if (match) {
          found = true;
          const card = document.createElement("div");
          card.className = "bg-white p-4 rounded-lg shadow hover:shadow-lg transition";
          card.innerHTML = `
            <h3 class="text-lg font-bold text-green-800 mb-2">${data.name || "Unnamed Item"}</h3>
            <p class="text-gray-700">Category: ${data.category || "N/A"}</p>
            <p class="text-gray-700">Location: ${data.location || "Unknown"}</p>
            <p class="text-gray-700 font-semibold mt-2">${data.price ? data.price + " KES/kg" : ""}</p>
          `;
          marketplaceContainer.appendChild(card);
        }
      });

      noResults.classList.toggle("hidden", found);
    }

    // Real-time filter trigger
    function applyFilters() {
      const categoryValue = filterCategory.value.toLowerCase();
      const searchValue = searchInput.value.toLowerCase();
      const locationValue = filterLocation.value.toLowerCase();
      loadMarketplace(categoryValue, searchValue, locationValue);
    }

    // Event Listeners
    searchInput.addEventListener("input", applyFilters);
    filterLocation.addEventListener("input", applyFilters);
    filterCategory.addEventListener("change", applyFilters);

    // Initialize on page load
    window.addEventListener("DOMContentLoaded", () => {
      loadCategories();
      loadMarketplace();
    });
  </script>
</body>
</html>

      
