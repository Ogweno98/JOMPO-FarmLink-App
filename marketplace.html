<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Marketplace - JOMPO FarmLink</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Firebase (compat) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

  <link rel="stylesheet" href="style.css" />
</head>
<body class="bg-green-50 font-sans">
  <nav class="bg-green-800 text-white p-4 flex justify-between items-center">
    <a href="index.html" class="text-2xl font-bold">JOMPO FarmLink</a>
    <div id="authLinks"></div>
  </nav>

  <section class="py-10 px-6 md:px-20">
    <h2 class="text-3xl font-bold text-green-800 mb-6">Marketplace</h2>

    <div class="mb-6 flex flex-col md:flex-row gap-4">
      <input type="text" id="searchInput" placeholder="Search by name..." class="px-4 py-2 border rounded w-full md:w-1/3 focus:outline-none focus:ring-2 focus:ring-green-600">
      <input type="text" id="filterLocation" placeholder="Filter by location" class="px-4 py-2 border rounded w-full md:w-1/3 focus:outline-none focus:ring-2 focus:ring-green-600">
      <select id="filterCategory" class="px-4 py-2 border rounded w-full md:w-1/3 focus:outline-none focus:ring-2 focus:ring-green-600">
        <option value="">All Categories</option>
      </select>
    </div>

    <div id="noResults" class="hidden text-red-600 font-semibold mb-6">No items found. Try adjusting your filters.</div>
    <div id="marketplaceContainer" class="grid md:grid-cols-3 gap-6"></div>
  </section>

  <script src="app.js"></script>
  <!-- ðŸŒ¿ JOMPO Floating Chatbot -->
  <div id="chatbot"></div>
  <script src="chatbot.js"></script>
  <script src="navbar.js"></script>

  <!-- Intercept internal links and check target before navigating (prevents surprise 404s) -->
  <script>
    (function () {
      // Only run for same-origin links (internal)
      async function checkAndNavigate(url, anchor) {
        try {
          // Do a HEAD request first to see if file exists (GitHub Pages supports HEAD)
          const resp = await fetch(url, { method: 'HEAD' });
          if (resp.ok) {
            // file exists â€” allow normal navigation
            window.location.href = url;
          } else {
            // not found or other error â€” show helpful modal/alert
            showNotFound(url, resp.status);
          }
        } catch (err) {
          // network error (CORS, offline, etc.)
          showNotFound(url, 'network');
        }
      }

      function showNotFound(url, status) {
        const msg = status === 'network'
          ? `Cannot verify "${url}" (network error). Open in new tab to inspect.`
          : `The page "${url}" returned HTTP ${status}. It may not exist or filename/case might be wrong. Open in new tab to inspect.`;
        // Simple non-blocking UI: toast-like
        const toast = document.createElement('div');
        toast.className = 'fixed bottom-6 right-6 bg-yellow-100 text-yellow-900 px-4 py-3 rounded shadow-lg max-w-xs';
        toast.innerHTML = `
          <div class="font-bold mb-1">Page not available</div>
          <div class="text-sm mb-2">${escapeHtml(msg)}</div>
          <div class="flex gap-2 justify-end">
            <button id="open-new-tab" class="px-3 py-1 bg-green-600 text-white rounded">Open</button>
            <button id="dismiss-toast" class="px-3 py-1 bg-gray-200 rounded">Dismiss</button>
          </div>
        `;
        document.body.appendChild(toast);
        document.getElementById('open-new-tab').addEventListener('click', () => {
          window.open(url, '_blank');
          toast.remove();
        });
        document.getElementById('dismiss-toast').addEventListener('click', () => toast.remove());
        // auto remove after 10s
        setTimeout(()=> toast.remove(), 10000);
      }

      function escapeHtml(unsafe) {
        return unsafe.replace(/[&<"']/g, function(m){ return ({'&':'&amp;','<':'&lt;','"':'&quot;',"'" :'&#039;'}[m]);});
      }

      // Attach delegated listener for clicks on links
      document.addEventListener('click', function (ev) {
        // find closest anchor
        const a = ev.target.closest && ev.target.closest('a');
        if (!a) return;
        const href = a.getAttribute('href');
        // If no href or external link, let it pass
        if (!href || href.startsWith('http') || href.startsWith('mailto:') || href.startsWith('tel:')) return;

        // Only intercept same-page relative links (no hash navigation)
        // Allow anchor links on same page (#)
        if (href.startsWith('#')) return;

        // Prevent default and check first
        ev.preventDefault();
        // build absolute URL relative to current origin
        const url = new URL(href, window.location.href).toString();
        // Only check same-origin
        if (url.startsWith(location.origin)) {
          checkAndNavigate(url, a);
        } else {
          // external origin â€” open normally
          window.location.href = url;
        }
      }, false);
    })();
  </script>
</body>
</html>
